<?xml version="1.0"?>
<!-- -->
<launch>

	<arg name="navigation" default="false"/>
	<arg name="localization" default="true"/>
	<arg name="icp_odometry" default="true"/>
	<arg name="rtabmap_viz" default="false"/>
	<arg name="camera" default="false"/>
	<arg name="lidar2d" default="false"/>
	<arg name="lidar3d" default="true"/>
	<arg name="lidar3d_ray_tracing" default="true"/>
	<arg name="slam2d" default="false"/>
	<arg name="depth_from_lidar" default="false"/>


	<arg name="cell_size" default="0.1"/>

	<arg if="$(arg lidar3d)" name="lidar_args" default="
      --Reg/Strategy 1
      --RGBD/NeighborLinkRefining true
      --ICP/PM true
      --Icp/OutlierRatio 0.7
      --Icp/VoxelSize $(arg cell_size)
      --Icp/MaxCorrespondenceDistance 1
      --Icp/PointToPlaneGroundNormalsUp 0.9
      --Icp/Iterations 10 
      --Icp/Epsilon 0.001
      --OdomF2M/ScanSubtractRadius $(arg cell_size)
      --OdomF2M/ScanMaxSize 15000
      --Odom/ScanKeyFrameThr 0.5
      --Grid/ClusterRadius 1
      --Grid/RangeMax 20
      --Grid/RayTracing true
      --Grid/CellSize $(arg cell_size)
      --Icp/PointToPlaneRadius 0
      --Icp/PointToPlaneK 10
      --Icp/MaxTranslation 1"/>

	<!--- Run rtabmap -->
	<remap from="/rtabmap/grid_map" to="/map"/>
	<remap from="/rtabmap/initialpose" to="/initialpose"/>


	<include file="$(find rover_launch)/launch/include/slam_node.launch">
		<arg if="$(arg localization)" name="args" value="--Reg/Force3DoF false" />

		<!-- create new map -->
		<arg name="localization" value="$(arg localization)" />
		<arg name="visual_odometry" value="false" />
		<arg name="approx_sync" value="true" />
		<arg name="imu_topic" value="/imu/data" />
		<arg unless="$(arg icp_odometry)" name="odom_topic" value="/raw_odom" />
		<arg name="frame_id" value="base_footprint" />
		<arg name="rtabmap_viz" value="$(arg rtabmap_viz)" />
		<!-- <arg name="gps_topic" value="/fix"/> -->
		<arg name="database_path" value="~/.ros/rtabmap_t1.db" />

		<!-- 2D LiDAR -->
		<arg name="subscribe_scan" value="false" />
		<!-- 3D LiDAR -->
		<arg name="subscribe_scan_cloud" value="true" />
		<arg name="scan_cloud_topic" value="/output_filter" />

		<arg name="initial_pose" value="0 0 0 0 0 0" />



		<!-- If camera is used -->
		<arg name="depth" value="$(eval camera and not depth_from_lidar)" />
		<arg name="subscribe_rgb" value="$(eval camera)" />
		<arg name="rgbd_sync" value="$(eval camera and not depth_from_lidar)" />
		<arg name="rgb_topic" value="/realsense/color/image_raw" />
		<arg name="camera_info_topic" value="/realsense/color/camera_info" />
		<arg name="depth_topic" value="/realsense/depth/image_rect_raw" />
		<arg name="approx_rgbd_sync" value="false" />

		<arg name="odom_expected_rate" value="30"/>


		<!-- If depth generated from lidar projection (in case we have only a single RGB camera with a 3D lidar) -->
		<arg name="gen_depth" value="$(arg depth_from_lidar)" />
		<arg name="gen_depth_decimation" value="4" />
		<arg name="gen_depth_fill_holes_size" value="3" />
		<arg name="gen_depth_fill_iterations" value="1" />
		<arg name="gen_depth_fill_holes_error" value="0.3" />

		<!-- If icp_odometry is used -->
		<arg if="$(arg icp_odometry)" name="icp_odometry" value="true" />
		<arg if="$(arg icp_odometry)" name="vo_frame_id" value="icp_odom" />
		<arg unless="$(arg slam2d)" name="wait_imu_to_init" value="false" />
		<arg if="$(arg lidar3d)" name="odom_args" value="--Icp/CorrespondenceRatio 0.01"/>


	</include>

	<!-- <node name="gps_rviz" pkg="rviz" type="rviz" args="-d /home/wilson/catkin_ws/src/rover_base_driver/rover_bringup/rviz/gps.rviz"/> -->

</launch>